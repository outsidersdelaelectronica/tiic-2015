/*
 * filters.c
 *
 *  Created on: 15/12/2015
 *      Author: tvalno
 */

#include "filters.h"

#define INTEGRATION_LENGTH 16
#define BP_ORDER 252
//#define H_ORDER 311
#define L_ORDER 50
#define DIF_ORDER 32

// 1-35 hz BP ( 250 SPS)
//const int32_t band_pass_coef[BP_ORDER] = {4, 6, 7, 5, -1, -7, -13, -16, -15, -10, -4, -1, 0, -3, -6, -7,
//		-6, -3, 0, 0, -1, -3, -5, -5, -3, -1, 0, -1, -3, -5, -5, -3, -1, 0, -1, -3, -5, -5, -3, -1, 0, -1,
//		-3, -5, -5, -4, -1, 0, -1, -3, -6, -6, -4, -1, 0, -1, -4, -6, -6, -4, -2, 0, -1, -4, -6, -7, -5,
//		-2, 0, -1, -4, -7, -8, -5, -2, 1, 0, -4, -7, -8, -6, -2, 1, 0, -4, -8, -9, -7, -2, 2, 1, -3, -8,
//		-10, -8, -2, 2, 2, -3, -9, -12, -9, -2, 3, 3, -2, -10, -14, -10, -2, 5, 5, -2, -11, -16, -13, -2,
//		7, 9, 0, -13, -21, -17, -2, 12, 15, 3, -17, -30, -25, -2, 24, 32, 12, -28, -63, -60, -2, 99, 207,
//		276, 276, 207, 99, -2, -60, -63, -28, 12, 32, 24, -2, -25, -30, -17, 3, 15, 12, -2, -17, -21, -13,
//		0, 9, 7, -2, -13, -16, -11, -2, 5, 5, -2, -10, -14, -10, -2, 3, 3, -2, -9, -12, -9, -3, 2, 2, -2,
//		-8, -10, -8, -3, 1, 2, -2, -7, -9, -8, -4, 0, 1, -2, -6, -8, -7, -4, 0, 1, -2, -5, -8, -7, -4, -1,
//		0, -2, -5, -7, -6, -4, -1, 0, -2, -4, -6, -6, -4, -1, 0, -1, -4, -6, -6, -3, -1, 0, -1, -4, -5, -5,
//		-3, -1, 0, -1, -3, -5, -5, -3, -1, 0, -1, -3, -5, -5, -3, -1, 0, -1, -3, -5, -5, -3, -1, 0, 0, -3,
//		-6, -7, -6, -3, 0, -1, -4, -10, -15, -16, -13, -7, -1, 5, 7, 6, 4
//};
// 1-95hz bp (250 SPS)
//const int32_t band_pass_coef[BP_ORDER] = {7, 5, -16, -16, 0, -5, -6, 1, -4, -2, 1, -4, 0, -1, -3, 0, -2, -2, 0, -3, -1,
//		-1, -3, 0, -3, -2, -1, -3, -1, -2, -3, -1, -3, -2, -1, -3, -1, -3, -3, -1, -3, -2, -2, -3, -1, -3, -2, -1, -4,
//		-1, -3, -3, -1, -4, -2, -2, -4, -1, -3, -3, -1, -4, -2, -3, -4, -1, -4, -3, -2, -4, -1, -3, -4, -1, -5, -2, -2,
//		-5, -1, -4, -3, -1, -5, -1, -3, -4, -1, -5, -2, -2, -5, -1, -4, -4, -1, -5, -2, -2, -5, 0, -5, -3, -1, -6, -1,
//		-3, -5, 0, -6, -2, -2, -6, 0, -5, -4, 0, -6, -1, -3, -6, 1, -6, -3, 0, -7, 1, -4, -5, 1, -7, -1, -1, -7, 2, -6,
//		-4, 1, -8, 1, -3, -7, 3, -7, -2, 0, -9, 3, -5, -5, 3, -9, 1, -1, -9, 5, -8, -3, 3, -11, 4, -4, -8, 7, -11, 0, 2,
//		-13, 8, -8, -6, 9, -16, 6, -1, -15, 14, -15, -1, 10, -24, 17, -8, -16, 26, -32, 12, 11, -44, 50, -38, -16, 83,
//		-165, 218, 779, 218, -165, 83, -16, -38, 50, -44, 11, 12, -32, 26, -16, -8, 17, -24, 10, -1, -15, 14, -15, -1,
//		6, -16, 9, -6, -8, 8, -13, 2, 0, -11, 7, -8, -4, 4, -11, 3, -3, -8, 5, -9, -1, 1, -9, 3, -5, -5, 3, -9, 0, -2,
//		-7, 3, -7, -3, 1, -8, 1, -4, -6, 2, -7, -1, -1, -7, 1, -5, -4, 1, -7, 0, -3, -6, 1, -6, -3, -1, -6, 0, -4, -5,
//		0, -6, -2, -2, -6, 0, -5, -3, -1, -6, -1, -3, -5, 0, -5, -2, -2, -5, -1, -4, -4, -1, -5, -2, -2, -5, -1, -4, -3,
//		-1, -5, -1, -3, -4, -1, -5, -2, -2, -5, -1, -4, -3, -1, -4, -2, -3, -4, -1, -4, -3, -2, -4, -1, -3, -3, -1, -4,
//		-2, -2, -4, -1, -3, -3, -1, -4, -1, -2, -3, -1, -3, -2, -2, -3, -1, -3, -3, -1, -3, -1, -2, -3, -1, -3, -2, -1,
//		-3, -1, -2, -3, 0, -3, -1, -1, -3, 0, -2, -2, 0, -3, -1, 0, -4, 1, -2, -4, 1, -6, -5, 0, -16, -16, 5, 7
//};

// 5-90hz bp (500 SPS)
const int32_t band_pass_coef[BP_ORDER] = {-1, -2, 0, 5, 9, 9, 3, -4, -6, -4, 0, 1, -2, -4, -2, 1, 2, 0, -2, 0, 2, 3, 1, 0,
		1, 3, 4, 2, 0, 2, 4, 4, 2, 0, 2, 4, 4, 1, 0, 2, 4, 4, 1, -1, 1, 4, 3, 0, -2, 1, 3, 2, -2, -3, 0, 3, 1, -3, -4, -1,
		3, 0, -4, -5, -1, 2, -1, -6, -7, -2, 2, -2, -8, -8, -2, 1, -3, -10, -10, -3, 0, -5, -12, -11, -3, 0, -7, -15, -13,
		-3, 0, -9, -18, -14, -3, 0, -11, -21, -16, -2, 0, -14, -25, -17, 0, 1, -17, -30, -18, 3, 3, -21, -37, -19, 11, 9,
		-29, -51, -20, 32, 25, -52, -104, -20, 191, 374, 374, 191, -20, -104, -52, 25, 32, -20, -51, -29, 9, 11, -19, -37,
		-21, 3, 3, -18, -30, -17, 1, 0, -17, -25, -14, 0, -2, -16, -21, -11, 0, -3, -14, -18, -9, 0, -3, -13, -15, -7, 0,
		-3, -11, -12, -5, 0, -3, -10, -10, -3, 1, -2, -8, -8, -2, 2, -2, -7, -6, -1, 2, -1, -5, -4, 0, 3, -1, -4, -3, 1, 3,
		0, -3, -2, 2, 3, 1, -2, 0, 3, 4, 1, -1, 1, 4, 4, 2, 0, 1, 4, 4, 2, 0, 2, 4, 4, 2, 0, 2, 4, 3, 1, 0, 1, 3, 2, 0, -2,
		0, 2, 1, -2, -4, -2, 1, 0, -4, -6, -4, 3, 9, 9, 5, 0, -2, -1
};
// differentiator (250 SPS)
//const int32_t diferentiator_coef[DIF_ORDER] = { -4, 6, -3, 3, -3, 3, -4, 5, -6, 8, -11, 16, -27, 52, -145, 1304, -1304,
//												145, -52, 27, -16, 11, -8, 6, -5, 4, -3, 3, -3, 3, -6, 4};
// differentiator (500 SPS)
const int32_t diferentiator_coef[DIF_ORDER] = {-4, 6, -3, 3, -3, 3, -4, 5, -6, 8, -11, 16, -27, 52, -145, 1304, -1304, 145,
												-52, 27, -16, 11, -8, 6, -5, 4, -3, 3, -3, 3, -6, 4};

//const int32_t low_coef[L_ORDER] = { -18, -16, 11, -6, 1, 4, -9, 12, -11, 8, 0, -9, 18, -23, 21, -12, -4, 24, -44, 56, -53, 29, 28,
//		-149, 628, 628, -149, 28, 29, -53, 56, -44, 24, -4, -12, 21, -23, 18, -9, 0, 8, -11, 12, -9, 4, 1, -6, 11, -16, -18};



int32_t band_pass_filterino(int32_t value)
{
	static int32_t bp_buffer[(BP_ORDER - 1)];
	int i;
	int32_t y_n = 0;

	for(i = (BP_ORDER - 2); i > 0; i-- ){
        y_n += (band_pass_coef[i + 1]) * (bp_buffer[i]);
        bp_buffer[i] = bp_buffer[i-1];
	}

    y_n += band_pass_coef[1] * bp_buffer[0];
    bp_buffer[0] = value;

    y_n = y_n + band_pass_coef[0] * value;

    y_n = (y_n >> 10);

    return y_n;
}

//int32_t low_pass_filterino(int32_t value)
//{
//	static int32_t low_buffer[(L_ORDER - 1)];
//	int i;
//	int32_t y_n = 0;
//
//	for(i = (L_ORDER - 2); i > 0; i-- ){
//        y_n += (low_coef[i + 1]) * (low_buffer[i]);
//        low_buffer[i] = low_buffer[i-1];
//	}
//
//    y_n += low_coef[1] * low_buffer[0];
//    low_buffer[0] = value;
//
//    y_n = y_n + low_coef[0] * value;
//
//    y_n = (y_n >> 10);
//
//    return y_n;
//}

int32_t diferentiator_3000(int32_t value)
{
	static int32_t dif_buffer[(DIF_ORDER - 1)];
	int i;
	int32_t y_n = 0;

	for(i = (DIF_ORDER - 2); i > 0; i-- ){
        y_n += (diferentiator_coef[i + 1]) * (dif_buffer[i]);
        dif_buffer[i] = dif_buffer[i-1];
	}

    y_n += diferentiator_coef[1] * dif_buffer[0];
    dif_buffer[0] = value;

    y_n = y_n + diferentiator_coef[0] * value;

    y_n = (y_n >> 10);

    return y_n;
}
int32_t integrator_3000(int32_t value)
{
	static int32_t buffer_x[INTEGRATION_LENGTH];
	int32_t x_n = value, y_n = 0;
	uint8_t i;

    for ( i = INTEGRATION_LENGTH - 1; i > 0; i--)
    {
    	y_n += buffer_x[i];
		buffer_x[i] = buffer_x[i-1];
    }

    y_n += buffer_x[0];
    buffer_x[0] = x_n;

	return ( y_n >> 5);
}

int32_t filter_sample(int32_t value)
{
	int32_t filtered_value = value;


	filtered_value = band_pass_filterino(filtered_value);

//	filtered_value = diferentiator_3000(filtered_value);
//
//	filtered_value = (filtered_value >> 4) * (filtered_value >> 4);
//
//	filtered_value = integrator_3000(filtered_value);

	return filtered_value;											//Return true
}
