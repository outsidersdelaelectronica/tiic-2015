/*
 * filters.c
 *
 *  Created on: 15/12/2015
 *      Author: tvalno
 */

#include "filters.h"

#define INTEGRATION_LENGTH 32
#define BP_ORDER 230
#define H_ORDER 311
#define L_ORDER 40
#define DIF_ORDER 32

const int32_t band_pass_coef[BP_ORDER] = {-15, 2, 2, 2, 1, -1, -3, -5, -7, -9, -8, -7, -5, -2, 0, 1, 0, -1, -2, -3, -4,
		-3, -2, -1, 0, -1, -2, -4, -5, -6, -6, -4, -2, -1, 0, -1, -2, -4, -6, -7, -6, -4, -2, 0, 0, -1, -3, -6, -8, -8,
		-7, -4, -2, 0, 0, -2, -5, -8, -9, -9, -7, -4, -1, 1, 0, -2, -6, -10, -11, -10, -7, -3, 1, 2, 1, -3, -8, -12, -14,
		-12, -7, -1, 3, 4, 2, -4, -11, -16, -17, -14, -6, 2, 8, 8, 3, -6, -16, -24, -24, -17, -4, 10, 20, 19, 8, -12, -34,
		-49, -49, -29, 12, 66, 124, 173, 200, 200, 173, 124, 66, 12, -29, -49, -49, -34, -12, 8, 19, 20, 10, -4, -17, -24,
		-24, -16, -6, 3, 8, 8, 2, -6, -14, -17, -16, -11, -4, 2, 4, 3, -1, -7, -12, -14, -12, -8, -3, 1, 2, 1, -3, -7, -10,
		-11, -10, -6, -2, 0, 1, -1, -4, -7, -9, -9, -8, -5, -2, 0, 0, -2, -4, -7, -8, -8, -6, -3, -1, 0, 0, -2, -4, -6,
		-7, -6, -4, -2, -1, 0, -1, -2, -4, -6, -6, -5, -4, -2, -1, 0, -1, -2, -3, -4, -3, -2, -1, 0, 1, 0, -2, -5, -7,
		-8, -9, -7, -5, -3, -1, 1, 2, 2, 2, -15
};


const int32_t diferentiator_coef[DIF_ORDER] = { -4, 6, -3, 3, -3, 3, -4, 5, -6, 8, -11, 16, -27, 52, -145, 1304, -1304,
												145, -52, 27, -16, 11, -8, 6, -5, 4, -3, 3, -3, 3, -6, 4};

int32_t band_pass_filterino(int32_t value)
{
	static int32_t bp_buffer[(BP_ORDER - 1)];
	int i;
	int32_t y_n = 0;

	for(i = (BP_ORDER - 2); i > 0; i-- ){
        y_n += (band_pass_coef[i + 1]) * (bp_buffer[i]);
        bp_buffer[i] = bp_buffer[i-1];
	}

    y_n += band_pass_coef[1] * bp_buffer[0];
    bp_buffer[0] = value;

    y_n = y_n + band_pass_coef[0] * value;

    y_n = (y_n >> 10);

    return y_n;
}

int32_t diferentiator_3000(int32_t value)
{
	static int32_t dif_buffer[(DIF_ORDER - 1)];
	int i;
	int32_t y_n = 0;

	for(i = (DIF_ORDER - 2); i > 0; i-- ){
        y_n += (diferentiator_coef[i + 1]) * (dif_buffer[i]);
        dif_buffer[i] = dif_buffer[i-1];
	}

    y_n += diferentiator_coef[1] * dif_buffer[0];
    dif_buffer[0] = value;

    y_n = y_n + diferentiator_coef[0] * value;

    y_n = (y_n >> 10);

    return y_n;
}
int32_t integrator_3000(int32_t value)
{
	static int32_t buffer_x[INTEGRATION_LENGTH] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
													0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
	int32_t x_n = value, y_n = 0;
	uint8_t i;

    for ( i = INTEGRATION_LENGTH - 1; i > 0; i--)
    {
    	y_n += buffer_x[i];
		buffer_x[i] = buffer_x[i-1];
    }

    y_n += buffer_x[0];
    buffer_x[0] = x_n;

	return ( y_n >> 5);
}

int32_t filter_sample(int32_t value)
{
	int32_t filtered_value = value;


	filtered_value = band_pass_filterino(filtered_value);
	filtered_value = diferentiator_3000(filtered_value);

//	filtered_value = (filtered_value >> 4) * (filtered_value >> 4);
//
//	filtered_value = integrator_3000(filtered_value);

	return filtered_value;											//Return true
}
