/*
 * filters.c
 *
 *  Created on: 15/12/2015
 *      Author: tvalno
 */

#include "filters.h"

#define INTEGRATION_LENGTH 32
#define BP_ORDER 305//601
#define DIF_ORDER 32//16

//// FIR BPF 1-40 hz (1000 SPS / ORDER 600)
//const int32_t band_pass_coef[BP_ORDER] = {
//  -2, -1, -1, -1, -2, -2, -2, -2, -2, -3, -3, -3, -3, -2, -2, -2, -2, -2, -1, 
//  -1, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, -1, -1, -1, -1, -1, -2, -2, -2, -2, 
//  -1, -1, -1, -1, -1, -1, 0, 0, 0, 0, 0, 0, 0, 0, -1, -1, -1, -1, -1, -2, -2, 
//  -2, -2, -2, -2, -2, -1, -1, -1, -1, -1, -1, 0, 0, 0, 0, 0, -1, -1, -1, -1, 
//  -1, -2, -2, -2, -2, -2, -2, -2, -2, -2, -2, -1, -1, -1, -1, -1, 0, 0, 0, 0, 
//  -1, -1, -1, -1, -2, -2, -2, -2, -2, -2, -3, -2, -2, -2, -2, -2, -1, -1, -1, 
//  -1, 0, 0, 0, 0, -1, -1, -1, -1, -2, -2, -2, -3, -3, -3, -3, -3, -3, -3, -2, 
//  -2, -2, -1, -1, -1, 0, 0, 0, 0, 0, -1, -1, -1, -2, -2, -3, -3, -3, -3, -4, -4,
//  -3, -3, -3, -3, -2, -2, -1, -1, 0, 0, 0, 0, 0, 0, -1, -1, -2, -2, -3, -3, -4,
//  -4, -4, -4, -4, -4, -4, -3, -3, -2, -1, -1, 0, 0, 1, 1, 1, 0, 0, -1, -1, -2, 
//  -3, -4, -4, -5, -5, -5, -5, -5, -4, -4, -3, -2, -1, -1, 0, 1, 1, 2, 2, 1, 1, 
//  0, -1, -2, -3, -4, -5, -6, -6, -7, -7, -6, -6, -5, -4, -3, -1, 0, 1, 2, 3, 3,
//  3, 3, 2, 1, 0, -1, -3, -5, -6, -8, -9, -10, -10, -10, -9, -7, -6, -4, -2, 1, 
//  3, 5, 7, 8, 8, 8, 7, 5, 3, 0, -3, -7, -10, -14, -17, -19, -20, -21, -20, -17,
//  -13, -8, -2, 6, 15, 24, 33, 43, 52, 60, 68, 74, 78, 81, 82, 81, 78, 74, 68, 
//  60, 52, 43, 33, 24, 15, 6, -2, -8, -13, -17, -20, -21, -20, -19, -17, -14, 
//  -10, -7, -3, 0, 3, 5, 7, 8, 8, 8, 7, 5, 3, 1, -2, -4, -6, -7, -9, -10, -10, 
//  -10, -9, -8, -6, -5, -3, -1, 0, 1, 2, 3, 3, 3, 3, 2, 1, 0, -1, -3, -4, -5, 
//  -6, -6, -7, -7, -6, -6, -5, -4, -3, -2, -1, 0, 1, 1, 2, 2, 1, 1, 0, -1, -1, 
//  -2, -3, -4, -4, -5, -5, -5, -5, -5, -4, -4, -3, -2, -1, -1, 0, 0, 1, 1, 1, 0, 
//  0, -1, -1, -2, -3, -3, -4, -4, -4, -4, -4, -4, -4, -3, -3, -2, -2, -1, -1, 0, 
//  0, 0, 0, 0, 0, -1, -1, -2, -2, -3, -3, -3, -3, -4, -4, -3, -3, -3, -3, -2, -2,
//  -1, -1, -1, 0, 0, 0, 0, 0, -1, -1, -1, -2, -2, -2, -3, -3, -3, -3, -3, -3, -3,
//  -2, -2, -2, -1, -1, -1, -1, 0, 0, 0, 0, -1, -1, -1, -1, -2, -2, -2, -2, -2, -3,
//  -2, -2, -2, -2, -2, -2, -1, -1, -1, -1, 0, 0, 0, 0, -1, -1, -1, -1, -1, -2, -2,
//  -2, -2, -2, -2, -2, -2, -2, -2, -1, -1, -1, -1, -1, 0, 0, 0, 0, 0, -1, -1, -1,
//  -1, -1, -1, -2, -2, -2, -2, -2, -2, -2, -1, -1, -1, -1, -1, 0, 0, 0, 0, 0, 0,
//  0, 0, -1, -1, -1, -1, -1, -1, -2, -2, -2, -2, -1, -1, -1, -1, -1, 0, 0, 0, 0,
//  0, 0, 0, 0, 0, 0, 0, -1, -1, -1, -2, -2, -2, -2, -2, -3, -3, -3, -3, -2, -2,
//  -2, -2, -2, -1, -1, -1, -2
//};
// FIR BPF 2-35 hz (500 SPS / ORDER 305)
const int32_t band_pass_coef[BP_ORDER] = {
  -10, -15, 1, -8, -2, -4, -1, -1, 0, 0, 0, 0, -1, -2, -2, -3, -3, -3, -3, -2, 
  -2, -1, 0, 0, 0, -1, -1, -2, -3, -4, -4, -4, -3, -3, -2, -1, 0, 0, 0, -1, -2,
  -3, -4, -5, -5, -5, -4, -3, -2, -1, 0, 0, 0, -1, -2, -3, -5, -5, -6, -6, -5,
  -4, -2, -1, 0, 0, 0, -1, -3, -4, -6, -7, -7, -7, -6, -4, -2, -1, 0, 0, 0, -1,
  -3, -5, -7, -8, -8, -8, -6, -4, -2, 0, 1, 1, 1, -1, -3, -6, -8, -9, -10, -9, 
  -7, -5, -2, 1, 2, 3, 2, 0, -4, -7, -10, -12, -13, -11, -9, -5, -1, 3, 5, 6, 4,
  1, -4, -9, -14, -17, -18, -16, -12, -5, 2, 8, 13, 14, 12, 5, -4, -15, -25, 
  -33, -37, -33, -23, -5, 18, 46, 75, 101, 123, 137, 142, 137, 123, 101, 75, 
  46, 18, -5, -23, -33, -37, -33, -25, -15, -4, 5, 12, 14, 13, 8, 2, -5, -12, 
  -16, -18, -17, -14, -9, -4, 1, 4, 6, 5, 3, -1, -5, -9, -11, -13, -12, -10, -7,
  -4, 0, 2, 3, 2, 1, -2, -5, -7, -9, -10, -9, -8, -6, -3, -1, 1, 1, 1, 0, -2, 
  -4, -6, -8, -8, -8, -7, -5, -3, -1, 0, 0, 0, -1, -2, -4, -6, -7, -7, -7, -6, 
  -4, -3, -1, 0, 0, 0, -1, -2, -4, -5, -6, -6, -5, -5, -3, -2, -1, 0, 0, 0, -1, 
  -2, -3, -4, -5, -5, -5, -4, -3, -2, -1, 0, 0, 0, -1, -2, -3, -3, -4, -4, -4,
  -3, -2, -1, -1, 0, 0, 0, -1, -2, -2, -3, -3, -3, -3, -2, -2, -1, 0, 0, 0, 0, 
  -1, -1, -4, -2, -8, 1, -15, -10
};

// FIR DIF (500 SPS)
const int32_t diferentiator_coef[DIF_ORDER] = {
  -4, 6, -3, 3, -3, 3, -4, 5, -6, 8, -11, 16, -27, 52, -145, 1304, -1304, 145,
  -52, 27, -16, 11, -8, 6, -5, 4, -3, 3, -3, 3, -6, 4};
//const int32_t diferentiator_coef[DIF_ORDER] = {-4, 6, -3, 3, -3, 3, -4, 5, -6, 
//                                              8, -11, 16, -27, 52, -145, 1304 };

int32_t band_pass_filterino(int32_t value)
{
  static int32_t bp_buffer[BP_ORDER] = {0};
  int i;
  int32_t y_n = 0; 

  bp_buffer[0] = value;
  
  for(i = (BP_ORDER - 1) ; i > 0; i-- ){
    y_n += ((band_pass_coef[i] * bp_buffer[i])>>10);
    bp_buffer[i] = bp_buffer[i-1];
  }
  y_n += ((band_pass_coef[0] * bp_buffer[0])>>10);

  return y_n;
}

int32_t diferentiator_3000(int32_t value)
{
  static int32_t dif_buffer[DIF_ORDER] = {0};
  int i;
  int32_t y_n = 0;

  dif_buffer[0] = value;
  
  for(i = (DIF_ORDER - 1); i > 0; i-- ){
    y_n += ((diferentiator_coef[i] * dif_buffer[i]) >> 10);
    dif_buffer[i] = dif_buffer[i-1];
  }

  y_n += ((diferentiator_coef[0] * dif_buffer[0]) >> 10);
  
  return y_n;
}
//FOLDED VERSION
//int32_t diferentiator_3000(int32_t value)
//{
//  static int32_t dif_buffer[((DIF_ORDER<<1) - 1)] = {0};
//  int i;
//  int32_t y_n = 0;
//
//  y_n = diferentiator_coef[(DIF_ORDER - 1)];
//  return y_n;
//}
int32_t integrator_3000(int32_t value)
{
  static int32_t buffer_x[INTEGRATION_LENGTH] = {0};
  int32_t x_n = value, y_n = 0;
  uint8_t i;

  for ( i = INTEGRATION_LENGTH - 1; i > 0; i--){
    y_n += (buffer_x[i] / INTEGRATION_LENGTH);
    buffer_x[i] = buffer_x[i-1];
  }

  y_n += (buffer_x[0] / INTEGRATION_LENGTH);
  buffer_x[0] = x_n;

  return y_n;
}

int32_t chuster_abs(int32_t value){
  if(value > 0){
    return value;
  }else{
    return (-1)*value;
  }
}
int32_t filter_sample(int32_t value)
{
  int32_t bp_filtered, dif_filtered, denormalized, integrated;
  static int32_t max_value = 1;
  float normalized, squared;

  bp_filtered = band_pass_filterino(value);
  dif_filtered = diferentiator_3000(bp_filtered);
  
  if( (chuster_abs(dif_filtered) > max_value) &&(dif_filtered != 0)){
    max_value = chuster_abs(dif_filtered);
  }
  
  normalized = ((float)dif_filtered)/max_value;
  squared = (normalized) * (normalized);
  denormalized = ((int32_t)(squared * max_value));
  integrated = integrator_3000(denormalized);

  return integrated;     

}
